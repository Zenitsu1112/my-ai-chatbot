<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>AI Chat</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 400px; margin: 0 auto; }
        input, button { padding: 12px; margin: 8px 0; width: 100%; font-size: 16px; }
        button { background: #667eea; color: white; border: none; cursor: pointer; }
        button:hover { background: #5568d3; }
        #out { border: 2px solid #ccc; padding: 15px; margin-top: 15px; min-height: 100px; background: #f9f9f9; white-space: pre-wrap; word-wrap: break-word; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h2>ü§ñ AI Chat</h2>
    
    <div id="login-section">
        <label>Password:</label>
        <input type="password" id="password-field" value="1112">
        <button id="login-button">üîì Connect to AI</button>
    </div>
    
    <div id="chat-section" style="display:none;">
        <div id="chat-history" style="border:1px solid #ddd; height:200px; overflow-y:auto; padding:10px; margin-bottom:10px; background:white;"></div>
        <input type="text" id="message-field" placeholder="Type your message...">
        <button id="send-button">üì§ Send</button>
    </div>
    
    <div id="out">Waiting for connection...</div>

    <script>
        // Debug: confirm script loaded
        console.log('‚úÖ JavaScript loaded successfully');
        document.getElementById('out').textContent = 'Ready. Click "Connect to AI" button.';
        
        const API_URL = 'https://my-ai-chatbot.zenitsu11-nezuko12.workers.dev';
        let currentPassword = '';
        
        // Login button - using addEventListener (more reliable than onclick)
        document.getElementById('login-button').addEventListener('click', async function() {
            console.log('üîë Login button clicked');
            
            const btn = this;
            const pwdField = document.getElementById('password-field');
            const out = document.getElementById('out');
            const pwd = pwdField.value.trim();
            
            if (!pwd) {
                out.innerHTML = '<span class="error">‚ùå Enter a password</span>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            out.textContent = 'Sending POST request to ' + API_URL + '...';
            
            try {
                console.log('Fetching:', API_URL);
                console.log('Body:', {password: pwd, message: 'Hello'});
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: pwd,
                        message: 'Hello test message'
                    })
                });
                
                console.log('Response status:', response.status);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                if (!response.ok) {
                    throw new Error('Server returned ' + response.status + ': ' + responseText);
                }
                
                const data = JSON.parse(responseText);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // SUCCESS!
                currentPassword = pwd;
                out.innerHTML = '<span class="success">‚úÖ Connected! AI says: ' + (data.reply || 'Ready') + '</span>';
                
                // Show chat section
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('chat-section').style.display = 'block';
                
                addChatMessage('AI', data.reply || 'Connected! How can I help?');
                
            } catch (error) {
                console.error('Error:', error);
                out.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
                btn.disabled = false;
                btn.textContent = 'üîì Connect to AI';
            }
        });
        
        // Send button
        document.getElementById('send-button').addEventListener('click', async function() {
            const msgField = document.getElementById('message-field');
            const msg = msgField.value.trim();
            
            if (!msg) return;
            
            addChatMessage('You', msg);
            msgField.value = '';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: currentPassword,
                        message: msg
                    })
                });
                
                const data = await response.json();
                addChatMessage('AI', data.reply || data.error || 'Error');
                
            } catch (error) {
                addChatMessage('AI', '‚ùå Error: ' + error.message);
            }
        });
        
        function addChatMessage(sender, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.style.margin = '5px 0';
            div.style.padding = '8px';
            div.style.borderRadius = '5px';
            div.style.background = sender === 'You' ? '#667eea' : '#e9e9e9';
            div.style.color = sender === 'You' ? 'white' : '#333';
            div.style.textAlign = sender === 'You' ? 'right' : 'left';
            div.textContent = sender + ': ' + text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }
        
        // Allow Enter key in message field
        document.getElementById('message-field').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });
        
        console.log('‚úÖ All event listeners attached');
    </script>
</body>
</html>
